name: Daily Skills Crawl

on:
  # Run daily at UTC 0:00
  schedule:
    - cron: '0 0 * * *'
  # Support manual trigger
  workflow_dispatch:
  # Run on push to main branch
  push:
    branches:
      - main

concurrency:
  group: skills-crawl-${{ github.ref }}
  cancel-in-progress: true

jobs:
  crawl:
    runs-on: ubuntu-latest
    # Note: GitHub-hosted runners have a hard ~6h job limit. Keep below that.
    timeout-minutes: 350
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Needed for pull --rebase and retry-safe pushes
          fetch-depth: 0
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Run crawler
        run: bun run crawl
        env:
          # Increase GitHub API rate limit for scanning plugin skill paths, etc.
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Keep backfilling SKILL.md until complete (batched to avoid timeouts).
          SYNC_ALL_SKILL_MDS: "1"
          SYNC_ALL_ONLY_MISSING: "1"
          # Keep each run comfortably below the GitHub job time limit.
          SYNC_ALL_TIME_BUDGET_MINUTES: "330"
          # Speed up backfill while keeping load reasonable.
          SYNC_ALL_CONCURRENCY: "8"

      # Build skill category index (bot pushes won't trigger other workflows)
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build category index
        run: python scripts/build_skill_category_index.py
      
      - name: Commit data updates
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/
          git diff --staged --quiet || git commit -m "chore: update skills data $(date +'%Y-%m-%d %H:%M:%S')"

          # Rebase onto latest main to avoid ref lock / non-fast-forward races
          git fetch origin main
          git rebase origin/main || (git rebase --abort && git reset --soft origin/main)

          # Retry push to tolerate concurrent runs
          for i in 1 2 3 4 5; do
            git push && break
            git fetch origin main
            git rebase origin/main || (git rebase --abort && git reset --soft origin/main)
            sleep $((i * 2))
          done
      
      # Translate descriptions (GitHub Actions bot push won't trigger other workflows)
      - name: Install translation dependencies
        run: pip install deep-translator
      
      - name: Run translation
        run: |
          # Translate up to 500 new descriptions per run
          python scripts/translate_descriptions.py --limit 500
      
      - name: Commit translations
        run: |
          git add data/skills-md/
          if git diff --staged --quiet; then
            echo "No new translations to commit"
          else
            git commit -m "chore: auto-translate description_en.txt to description_cn.txt"
            
            # Rebase and push
            git fetch origin main
            git rebase origin/main || (git rebase --abort && git reset --soft origin/main)
            
            for i in 1 2 3 4 5; do
              git push && break
              echo "Push failed, retrying ($i/5)..."
              git fetch origin main
              git rebase origin/main || (git rebase --abort && git reset --soft origin/main)
              sleep $((i * 2))
            done
          fi
